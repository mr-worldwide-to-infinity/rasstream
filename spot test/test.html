<!DOCTYPE html>
<html>
<head>
    <title>Spotify and Radio Control</title>
</head>
<body>
    <div id="statusContainer">
        <h2>Network Status</h2>
        <div id="networkStatus">Checking connection...</div>
    </div>

    <div id="wifiConfig">
        <h2>WiFi Configuration</h2>
        <button id="scanNetworks">Scan Networks</button>
        <ul id="networkList"></ul>
        <form id="wifiForm" style="display: none;">
            <label for="ssid">SSID:</label>
            <input type="text" id="ssid" name="ssid" required>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password">
            <button type="submit">Connect</button>
        </form>
    </div>

    <div id="spotifyContainer" style="display: none;">
        <h2>Spotify and Radio Control</h2>
        <button id="loginSpotify">Login met Spotify</button>
        <button id="pauseAll">Stop Radio</button>
        <button id="radio1">Radio 1</button>
        <button id="radio4">Radio 4</button>
    </div>

    <script>
        let serverUrl;

        async function determineServerUrl() {
            const hostname = 'spotStream.local';
            serverUrl = `http://${hostname}:3001`;
            console.log('Using hostname URL:', serverUrl);
            
            try {
                const response = await fetch(`${serverUrl}/status`);
                if (!response.ok) {
                    console.log('Could not connect using hostname, falling back to IP...');
                    // Fallback naar IP als hostname niet werkt
                    if (window.location.hostname === '192.168.4.1') {
                        serverUrl = 'http://192.168.4.1:3001';
                    } else {
                        serverUrl = window.location.protocol + '//' + window.location.hostname + ':3001';
                    }
                }
            } catch (error) {
                console.log('Error connecting to server:', error);
                // Fallback naar IP als hostname niet werkt
                if (window.location.hostname === '192.168.4.1') {
                    serverUrl = 'http://192.168.4.1:3001';
                } else {
                    serverUrl = window.location.protocol + '//' + window.location.hostname + ':3001';
                }
            }
        }

        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;

        async function checkConnection() {
            if (!serverUrl) {
                await determineServerUrl();
            }
            
            try {
                const response = await fetch(`${serverUrl}/status`);
                const status = await response.json();
                const networkStatus = document.getElementById('networkStatus');
                
                if (status.mode === 'AP') {
                    networkStatus.textContent = 'Running in Access Point mode';
                    document.getElementById('wifiConfig').style.display = 'block';
                    document.getElementById('spotifyContainer').style.display = 'none';
                } else if (status.connected) {
                    networkStatus.textContent = `Connected to: ${status.ssid}\nIP: ${status.ip}\nInternet: ${status.internet ? 'Yes' : 'No'}`;
                    document.getElementById('wifiConfig').style.display = 'none';
                    document.getElementById('spotifyContainer').style.display = 'block';
                } else {
                    networkStatus.textContent = status.message || 'Not connected to any network';
                    document.getElementById('wifiConfig').style.display = 'block';
                    document.getElementById('spotifyContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking connection:', error);
                document.getElementById('networkStatus').textContent = 'Unable to check connection status';
                document.getElementById('wifiConfig').style.display = 'block';
                await determineServerUrl();
            }
        }

        // Voer dit uit bij het laden van de pagina
        determineServerUrl().then(() => {
            // Start de normale check nadat we de juiste URL hebben
            checkConnection();
            setInterval(checkConnection, 30000);
        });

        // Bestaande event listeners
        document.getElementById("loginSpotify").onclick = function() {
            window.location.href = `${serverUrl}/login`;
        };

        document.getElementById('radio1').onclick = function() {
            fetch(`${serverUrl}/radio/play`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ station: 'radio1' })
            });
        };

        document.getElementById('radio4').onclick = function() {
            fetch(`${serverUrl}/radio/play`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ station: 'radio4' })
            });
        };

        document.getElementById('pauseAll').onclick = function() {
            fetch(`${serverUrl}/radio/stop`, {
                method: 'POST'
            });
        };

        async function scanNetworks() {
            try {
                const response = await fetch(`${serverUrl}/networks`);
                const networks = await response.json();
                const networkList = document.getElementById('networkList');
                networkList.innerHTML = '';
                networks.forEach(network => {
                    const li = document.createElement('li');
                    li.textContent = network.ssid;
                    li.onclick = () => selectNetwork(network.ssid);
                    networkList.appendChild(li);
                });
            } catch (error) {
                console.error('Fout bij scannen van netwerken:', error);
            }
        }

        function selectNetwork(ssid) {
            document.getElementById('ssid').value = ssid;
            document.getElementById('wifiForm').style.display = 'block';
        }

        document.getElementById('scanNetworks').onclick = scanNetworks;

        document.getElementById('wifiForm').onsubmit = async function(event) {
            event.preventDefault();
            const ssid = document.getElementById('ssid').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`${serverUrl}/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ssid, password })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Verbonden met WiFi-netwerk!');
                    // Meerdere pogingen om verbinding te controleren
                    const checkInterval = setInterval(() => {
                        if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                            clearInterval(checkInterval);
                            alert('Kon geen verbinding maken na meerdere pogingen');
                            return;
                        }
                        reconnectAttempts++;
                        checkConnection();
                    }, 5000);
                } else {
                    alert('Fout bij verbinden: ' + result.error);
                }
            } catch (error) {
                console.error('Fout bij verbinden met netwerk:', error);
                alert('Fout bij verbinden met netwerk');
            }
        };
    </script>
</body>
</html>
